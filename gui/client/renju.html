<!doctype html>
<!--
    renju-parallel
    Copyright (C) 2016 Yunzhu Li

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="keywords" content="Renju">
    <meta name="author" content="Yunzhu Li">
    <title>Renju</title>

    <link href="assets/bootstrap.min.css" rel="stylesheet">
    <link href="assets/yl-v4-main.css" rel="stylesheet">
    <link href="assets/proxima_nova.css" rel="stylesheet">
    <script src="assets/jquery-3.1.0.min.js"></script>
    <script src="assets/bootstrap.min.js"></script>
  </head>

  <body style="font-size: 14px; background-color: #fff; margin: 10px;">
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href=".">Renju</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-right">

            <li><a href="https://yunzhu.li/contact/" target="_blank">Contact</a></li>
            <li><a href="https://github.com/yunzhu-li/renju-parallel" target="_blank">Project on Github</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid" style="padding-top:10px;">
      <div class="row">
        <!-- Renju -->
        <div class="col-md-8">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Board</h3>
            </div>
            <div id="panel_gamearea" class="panel-body text-center">
              <div id="div_gamearea" style="margin: 0 auto; ">
                <table id="tbl_board" style="border-collapse: collapse; border-spacing: 0; background-color: #efefef;">
                </table>
              </div>
            </div>
          </div>
        </div>
        <!-- Status -->
        <div class="col-md-4">
          <div class="panel panel-default">
            <div class="panel-heading"><h3 class="panel-title">Game Status</h3></div>
            <div id="panel_status" class="panel-body"></div>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading"><h3 class="panel-title">Statistics</h3></div>
            <div id="panel_stats" class="panel-body" style="font-family: 'Monaco','Consolas','monospace'; font-size: 10px;"></div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
    // Script: Game display control, input and message
    // Preset graphics
    var svg_lines = [
      '<line x1="50%" y1="0" x2="50%" y2="50%" style="stroke:rgb(110,110,110); stroke-width:2px;" />',
      '<line x1="0" y1="50%" x2="50%" y2="50%" style="stroke:rgb(110,110,110); stroke-width:2px;" />',
      '<line x1="50%" y1="50%" x2="50%" y2="100%" style="stroke:rgb(110,110,110); stroke-width:2px;" />',
      '<line x1="50%" y1="50%" x2="100%" y2="50%" style="stroke:rgb(110,110,110); stroke-width:2px;" />',
      '<line x1="35%" y1="50%" x2="65%" y2="50%" style="stroke:rgb(150,150,150); stroke-width:2px;" />' +
      '<line x1="50%" y1="35%" x2="50%" y2="65%" style="stroke:rgb(150,150,150); stroke-width:2px;" />'];

    var svg_circles = [
      '<circle cx="50%" cy="50%" r="32%" fill="#333" />',
      '<circle cx="50%" cy="50%" r="32%" fill="#fff" />'];

    var colors = ['#bbb', '#777', '#eee'];

    // Bind elements
    var tbl_board = document.getElementById('tbl_board');
    var div_gamearea = document.getElementById('div_gamearea');

    // Global game variables
    var game_active;
    var current_board;
    var human_player, ai_player;

    init();

    // Initializes client
    function init() {
      // Board
      current_board = initBoard();

      // Randomly select first player
      human_player = '1';
      ai_player = '2';
      if (Math.random() > 0.5) {
        human_player = '2';
        ai_player = '1';
      }

      if (human_player == '2') {
        // Put a piece for black (AI)
        current_board = replaceCell(current_board, 7, 7, '1');
      }

      initGameDisplay();
      renderCurrentBoard();

      // Game status
      game_active = true;
      updateStatusPanel('Connected', playerColors());
    }

    // Initializes game display
    function initGameDisplay() {

      // Automatically adjust display size
      var container_size = panel_gamearea.offsetWidth - 32;

      // Control table size with cell size
      var cell_width = Math.floor((container_size) / 15);
      var cell_height = Math.floor((container_size) / 15);

      // No more blurry
      cell_width -= cell_width % 2;
      cell_height -= cell_height % 2;

      // Set containing div size
      div_gamearea.style.width = cell_width * 15 + 'px';
      div_gamearea.style.height = cell_height * 15 + 'px';

      // Initialize tbl_board
      for (var r = 0; r < 15; r++) {
        var row = tbl_board.insertRow();
        for (var c = 0; c < 15; c++) {
          // New cell and data
          var cell = row.insertCell();
          cell.r = r; cell.c = c;
          cell.board_data = '0';

          // Style
          cell.width = cell_width; cell.height = cell_height;
          cell.style.padding = '0';
          cell.style.verticalAlign = 'bottom';

          // Handle click event
          cell.addEventListener("click", tblBoardOnClick);
        }
      }
    }

    // Renders tbl_board with board data
    function renderCurrentBoard(new_piece_r, new_piece_c) {
      for (var r = 0; r < 15; r++) {
        for (var c = 0; c < 15; c++) {
          var cell = tbl_board.rows[r].cells[c];
          var cell_innerhtml = '<svg style="display: block; width: 100%; height: 100%;">';

          // Skip unchanged cells
          var cell_value = getCell(current_board, r, c);
          if (cell.cache_val == cell_value) continue;
          cell.cache_val = cell_value;

          // Grid (lines)
          if (r > 0)  cell_innerhtml += svg_lines[0];
          if (c > 0)  cell_innerhtml += svg_lines[1];
          if (r < 14) cell_innerhtml += svg_lines[2];
          if (c < 14) cell_innerhtml += svg_lines[3];

          // Pieces
          if (cell_value == '1') cell_innerhtml += svg_circles[0];
          if (cell_value == '2') cell_innerhtml += svg_circles[1];

          // Mark new piece
          if (typeof new_piece_r !== 'undefined' && typeof new_piece_c !== 'undefined') {
            if (new_piece_r == r && new_piece_c == c) {
              cell_innerhtml += svg_lines[4];

              // Refresh cell in next rendering
              cell.cache_val = -2;
            }
          }

          // Update node
          cell.innerHTML = cell_innerhtml + '</svg>';
        }
      }
    }

    // Initializes empty board
    function initBoard() {
      var b = [];
      for (var i = 0; i < 225; i++)
        b.push('0');

      return b.join('');
    }

    // Gets cell value
    function getCell(board, r, c) {
      return board[15 * r + c];
    }

    // Generates a new board after replacing a cell
    function replaceCell(board, r, c, val) {
      var idx = 15 * r + c;
      return board.substr(0, idx) + val + board.substr(idx + 1);
    }

    // Generates an HTML string of player colors
    function playerColors() {
      if (human_player == '1') {
        return 'Player: black<br>AI: white';
      } else {
        return 'Player: white<br>AI: black';
      }
    }

    // Handles tbl_board cells click events
    function tblBoardOnClick(e) {
      var r = e.currentTarget.r, c = e.currentTarget.c;

      if (!game_active) return;
      if (getCell(current_board, r, c) != '0') return;

      game_active = false;
      updateStatusPanel('Working', playerColors(), '#ff9800');

      // Place piece
      current_board = replaceCell(current_board, r, c, human_player);
      renderCurrentBoard(r, c);

      // Send game status
      sendGameStatus(current_board, ai_player);
    }

    // Updates status panel
    function updateStatusPanel(status, message, statusColor) {
      if (typeof statusColor === 'undefined') statusColor = '#00c853';

      // Generate status indicator
      var status_html = '<div class="status-indicator" style="background-color:' + statusColor + ';"></div>';

      // Append message
      status_html += ' ' + status;
      status_html += '<br><br>' + message;
      document.getElementById('panel_status').innerHTML = status_html;
    }

    // Sends status to backend api
    function sendGameStatus(board, ai_player) {
      var req_url = 'http://127.0.0.1/renju/?s=' + board + '&p=' + ai_player;

      $.get(req_url, function(data) {
        processResponse(data);
      });
    }

    // Process response from backend api
    function processResponse(data) {
      // Process response
      var result = $.parseJSON(data);
      if (result.result === null) {
        updateStatusPanel('Error', 'Failed to process response: ' + result.message, '#f44336');
        return;
      }

      // Extract data
      result = result.result;

      // Update board
      current_board = replaceCell(current_board, parseInt(result.move_r), parseInt(result.move_c), ai_player);
      renderCurrentBoard(result.move_r, result.move_c);

      // Winning
      if (result.winning_player == '1') {
        updateStatusPanel('Black wins! <a href="."><u>Restart</u></a>', playerColors(), '#448aff');
      } else if (result.winning_player == '2') {
        updateStatusPanel('White wins! <a href="."><u>Restart</u></a>', playerColors(), '#448aff');
      } else {
        game_active = true;
        updateStatusPanel('Connected', playerColors());
      }

      // Stats
      if (result.cpu_time == '0') result.cpu_time = '1';

      // Parse numbers
      result.cpu_time = parseInt(result.cpu_time);
      result.num_threads = parseInt(result.num_threads);
      result.eval_count = parseInt(result.eval_count);
      result.pm_count = parseInt(result.pm_count);

      // Build stats output
      var stats_html = '';
      stats_html += 'CPU time: ' + result.cpu_time / 1000 + 's';
      stats_html += '<br>Threads: ' + result.num_threads;
      stats_html += '<br>Moves evaluated: ' + numberWithCommas(result.eval_count) +
                    '(' + numberWithCommas(Math.floor(1000 * result.eval_count / result.cpu_time)) + '/s)';

      stats_html += '<br>Patterns matched: ' + numberWithCommas(result.pm_count) +
                    '(' + numberWithCommas(Math.floor(1000 * result.pm_count / result.cpu_time)) + '/s)';



      document.getElementById('panel_stats').innerHTML = stats_html;
    }

    // Formats a number with commas as thousands separators
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
  </script>
</html>
